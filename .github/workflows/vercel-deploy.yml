name: Vercel Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Pull Vercel Environment
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
        working-directory: ./frontend

      - name: Build Project
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
        working-directory: ./frontend

      - name: Deploy to Vercel
        id: deploy
        run: |
          URL=$(vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }})
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "### ðŸš€ Deployed to Vercel" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** $URL" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        working-directory: ./frontend

      - name: Verify Deployment
        run: |
          echo "Waiting 30s for deployment to propagate..."
          sleep 30
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://betfaro.com.br)
          echo "HTTP Status: $STATUS"
          if [ "$STATUS" != "200" ]; then
            echo "âŒ Deployment verification failed! Status: $STATUS"
            exit 1
          fi
          echo "âœ… Deployment verified successfully!"
          echo "### âœ… Verification Passed" >> $GITHUB_STEP_SUMMARY
          echo "Site is responding with HTTP 200" >> $GITHUB_STEP_SUMMARY

      - name: Output Deployment URL
        run: |
          echo "âœ… Deploy completed!"
          echo "URL: ${{ steps.deploy.outputs.url }}"
          echo "Commit: ${{ github.sha }}"
