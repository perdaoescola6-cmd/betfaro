name: Vercel Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  trigger-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Vercel Deploy Hook
        run: |
          echo "üöÄ Triggering Vercel deployment..."
          echo "Commit: ${{ github.sha }}"
          echo "Message: ${{ github.event.head_commit.message }}"
          
          # Trigger deploy via hook
          RESPONSE=$(curl -s -X POST "${{ secrets.VERCEL_DEPLOY_HOOK }}")
          echo "Response: $RESPONSE"
          
          # Extract job ID if available
          JOB_ID=$(echo $RESPONSE | jq -r '.job.id // empty')
          if [ -n "$JOB_ID" ]; then
            echo "‚úÖ Deploy triggered! Job ID: $JOB_ID"
            echo "### üöÄ Deploy Triggered" >> $GITHUB_STEP_SUMMARY
            echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
            echo "**Job ID:** $JOB_ID" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è Deploy hook response: $RESPONSE"
          fi

      - name: Wait for deployment
        run: |
          echo "Waiting 90s for Vercel to build and deploy..."
          sleep 90

      - name: Verify Deployment
        run: |
          echo "Checking if site is responding..."
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://betfaro.com.br)
          echo "HTTP Status: $STATUS"
          
          if [ "$STATUS" = "200" ]; then
            echo "‚úÖ Site is live and responding!"
            echo "### ‚úÖ Deployment Verified" >> $GITHUB_STEP_SUMMARY
            echo "Site responding with HTTP 200" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è Site returned status $STATUS (may still be deploying)"
            echo "### ‚ö†Ô∏è Verification Warning" >> $GITHUB_STEP_SUMMARY
            echo "Site returned HTTP $STATUS" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check API endpoint
        run: |
          echo "Checking API suggestions endpoint..."
          RESPONSE=$(curl -s "https://betfaro.com.br/api/suggestions?day=today" | head -c 200)
          echo "API Response (first 200 chars): $RESPONSE"
          
          if echo "$RESPONSE" | grep -q "suggestions\|items"; then
            echo "‚úÖ API is responding!"
          else
            echo "‚ö†Ô∏è API response unexpected"
          fi
